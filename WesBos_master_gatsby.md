# Notes on Master Gatsby

- Course by Wes Bos
- https://mastergatsby.com/


### Set up
- Like the "core concepts" sections at https://www.sanity.io/docs
- [Auto Rename Tag](https://marketplace.visualstudio.com/items?itemName=formulahendry.auto-rename-tag) is a handy VSCode extension

### Gatsby highlights
- As a __static site generator__, Gatsby generates pages _at build time_, not on page load in browser
  - HTML is already generated at deployment time via a build step
  - Not going page to page as much as signalling which prebuilt HTML to render and updating the URL to reflect the current app location
  - In contrast to an "on demand" site (e.g. WordPress), where URL slug is parsed, data pulled from database, template determined and HTML generated, and then data and template paired
  - A static site generator just does all that at build time instead of on demand
- Figures out __critical CSS__ and inlines it in a `style` tag so there's never the flash of unstyled content
- __Rehydration__: hooking React into prebuilt HTML, similar to SSR
  - Step 1: load prebuilt HTML
  - Step 2: update as needed via React
- __Lazy loading__ images
  - Image compression and file format (e.g. `.webp`)
- Built in __routing__ 
  - Observable in handling images on page load (deferred loading)
- Extensive __plugin ecosystem__
  - Similar to what people love about WordPress
- _Not_ a CMS
  - Need to set up own backend
- One trade off is that _dynamic pages_ need to be coded in a particular way

### Pages in Gatsby

- `public/` is generated by Gatsby
  - `gatsby clean` to blow out an regenerate
- Think twice before putting things in the `static/` folder
  - "Everything must go through Gatsby"
- Nice efficiency: __save-as__ to make a new file that's basically the same as a previous file
- Subtle naming-convention note: capitalized file names indicate a reusable component in React
  - These `page/` files are lowercase (like `index.js`) because they're not reusable

### Routing and Navigation
- `Link` component from Gatsby will use HTML5 push state
- For programmatic navigation (e.g. on form submit) `naviagte` method also exposed by Gatsby 

### Layouts in Gatsby
- `gatsby-browser.js` in root
  - `wrapPageElement`: can think of like a build step hook to add a layout (or any other "plugin" to page-level components)
- One of several browser APIs https://www.gatsbyjs.com/docs/browser-apis/
  - `shouldUpdateScroll`
  - `wrapRootElement`
  - `onRouteUpdate`
  - Several service worker related methods
- `gatsby-ssr.js` also needed to add this during server side rendering

### Global Styles
- If you included a CSS import in `gatsby-browser.js`, it would inject it as a critical CSS style tag in the production build
- Adding `normalize.css` import in `Layout`

```js
import bg from '../assets/images/bg.svg';
...
html {
    background-image: url(${bg});
}
```
- Gatsby facilitating this SVG import in `src/styles/GlobalStyles.js` 
  - This is "not JavaScript", as in an ESM couldn't import from an SVG like this
  - If this is a very small file, Gatsby will _convert the SVG asset into a base64 URL_, which saves a request for an image file
- If this is a standard file, any changes will result in a new, unique filename so the asset won't be cached 
  - Avoiding need to request hard refresh
  
```css
.gatsby-image-wrapper img[src*=base64\\,] {
    image-rendering: -moz-crisp-edges;
    image-rendering: pixelated;
  }
```
- In the prebuilt HTML, Gatsby includes images placeholders as a low res base64 string
  - This CSS will target that for the initial load
  - Once the image is retrieved from the server, this placeholder is replaced by the full-res version

- Includes cross-browser scroll bar styles

```css
html {
  ...
  font-size: 10px;
}
```
- He sets the base HTML to use `rem` units throughout
- `background-attachment` with differing values is fun 



### Typography

```js
import font from '../assets/fonts/frenchfries.woff';
```
- Gatsby will take this out of `assets/` and drop it into `static/` 

```js
export default function Layout({ children }) {
  return (
    <div>
      <GlobalStyles />
      <Typography />
```
- Including styles as React components is odd to me
  - He calls these "side effects"


### Styling Nav + Logo

```css
li {
  --rotate: -2deg;
  transform: rotate(var(--rotate));
  &:nth-child(1) {
    --rotate: 1deg;
}
```
- Declaring and then overriding a __CSS variable__ locally here is great
  - So much nicer than repeating the `transform` rule and all its other (unchanging) values

```js
<LogoStyles className="logo">
```
- Interesting Styled Components point: class is useful for targeting from other components (here `Nav`)

```css
const LogoStyles = styled.div`
  /* This value controls the entire size of the logo*/
  font-size: clamp(1px, 0.65vw, 8px);
  width: 30em;
  height: 30em;
  --borderSize: 1em;
```
- `clamp` here gives a min and max font size and allows the text to grow with the window within those bounds
- `em` units are then relative to the shared font size on the parent/container
  - Allows logo to be scaled up and down  
- Gatsby will add `aria-current="page"` to current nav links
  - Can be styled via `[aria-current="page"]{..}`

### Styling Layout

```css
margin: 12rem auto 4rem auto;
margin-top: clamp(2rem, 10vw, 12rem);
```
- `clamp` again used for responsive styles within bounds 
  - With fallback for nonsupporting browsers

## Modules 4 Headless CMS

### Setting up Sanity Headless CMS

- Headless as _not_ having a end user facing frontend (apart from our site, which is independent)
  - It's just the backend database
  - _Sanity Studio_ is the web UI for the CMS

```js
import { MdLocalPizza as icon } from 'react-icons/md';

export default {
  // Computer Name
  name: 'pizza',
  // visible title
  title: 'Pizzas',
  type: 'document',
  icon,
  // ..
```
- `react-icons` package seems handy
  - Just imports the icon and not the entire library 
  - `md` = material design
- Small note on elegant aliasing: `icon` can now be set as object-property shorthand

> Everything in the content studio starts with the `document`. A document is what you create and edit in the studio—all the other types you may define live inside the documents.
- `type: document` = https://www.sanity.io/docs/document-type

`schemas/pizza.js`

```js
{
  name: 'slug',
  title: 'Slug',
  type: 'slug',
  options: {
    source: 'name',
    maxLength: 100,
  },
},
```
- Slug is here generated from `name` field 

```js
validation: Rule => Rule.min(1000),
```
- Helper to validate inputs

### Creating the Toppings Content Type 

- __One-to-many__ relationship between a pizza and toppings

### Creating data relationships

`schemas/pizza.js`

```js
{
  name: 'toppings',
  title: 'Toppings',
  type: 'array',
  of: [{ type: 'reference', to: [{ type: 'topping' }] }],
},
```
- Using 2 difference field types
  - `array` and `reference`
  - https://www.sanity.io/docs/reference-type
  - https://www.sanity.io/docs/array-type

> Relations between documents are modeled using the `reference` type. To model a one-to-many relation, store the references in an array.

```js
preview: {
  select: {
    title: 'name',
    media: 'image',
    topping0: 'toppings.0.name',
    topping1: 'toppings.1.name',
    topping2: 'toppings.2.name',
    topping3: 'toppings.3.name',
  },
  prepare: ({ title, media, ...toppings }) => {
    // 1. Filter undefined toppings out
    const tops = Object.values(toppings).filter(Boolean);
    // 2. return the preview object for the pizza
    return {
      title,
      media,
      subtitle: tops.join(', '),
    };
  },
},
```
- `select` = what from the data model do you want to use and how to you want it mapped/identified into your `prepare` function
- `prepare` = display the data this way
- Nice little JS logic
  - _rest_ (or "gather") operator, `...toppings` taking all the parameters after `media`
  - Filtering out any that are `undefined` (because only 1–3 toppings)
  
### Custom CMS inputs in Sanity

```js
{
  name: 'price',
  title: 'Price',
  type: 'number',
  description: 'Price of the pizza in cents',
  validation: (Rule) => Rule.min(1000),
  inputComponent: PriceInput,
},
```
```js
export default function PriceInput({ type, value, onChange, inputComponent }) {
```
- Sanity will inject these props into a component at `inputComponent`

```js
function createPatchFrom(value) {
  return PatchEvent.from(value === '' ? unset() : set(Number(value)));
}
```
- Sanity custom input API via https://www.sanity.io/docs/custom-input-widgets
- Not so fun, but nice that you have the option to take control of an input field
  - Suppose the confusing/platform-specific part is just how the state change is handled
  
```js
PriceInput.focus = function () {
  this._inputElement.focus();
};
```
- a11y point is also a bit of a pain

## Modules 5: Getting Data into Gatsby with GraphQL

### `gatsby-config` and sourcing data

- Gatsby grabs all the data from the Sanity DB and sticks it in temporary memory to allow it to be queried
- _GraphiQL_ is like Swagger

```json
"build": "cross-env NODE_OPTIONS=\"-r esm\" gatsby build",
"develop": "cross-env NODE_OPTIONS=\"-r esm\" gatsby develop",
```
- `NODE_OPTIONS` config to allow ES Modules
  - Gatsby docs will have CommonJS examples

```js
export default {
  siteMetadata: {
    title: `Slicks Slices`,
    siteUrl: 'https://gatsby.pizza',
    description: 'The best pizza place in Hamilton!',
  },
};
```
- This addition to `gatsby-config.js` will be added to the sourced data we can query via GraphQL

- Styled Components plugin surfaces CSS to Gatsby to allow it to determine critical CSS

```js
  plugins: [
    'gatsby-plugin-styled-components',
    {
      // this is the name of the plugin you are adding
      resolve: 'gatsby-source-sanity',
      options: {
        projectId: 'ueupkwb4',
        dataset: 'production',
        watchMode: true,
        token: process.env.SANITY_TOKEN,
      },
    },
  ],
  ```
  - Plugin to allow sourcing data from sanity
    - `gatsby-source`

### Sourcing Sanity data

- CORS Origins don't matter _in development_ because Gatsby and Sanity will both be running in the same Node environment
  - In production, will need to set up CORS on Sanity
- Env variables prefixed with `GATSBY_` will be surfaced to the browser
- Need to deploy our Sanity API (https://www.sanity.io/docs/graphql#deploying-the-graphql-api-04501f1778aa)
- _GraphQL Playground_: very similar to _GraphiQL_ 
  - _GraphQL Playground_ = Sanity
  - _GraphiQL_ = Gatsby
- Having the deployed Sanity GraphQL API allows Gatsby to pull in all that data into _its own_ GraphQL api 
  - Key idea: there's __2 separate GraphQL APIs__ that are interacting with one another

```bash
> npm run develop
...
success copy gatsby files - 0.190s
info [sanity] Fetching remote GraphQL schema
info [sanity] Transforming to Gatsby-compatible GraphQL SDL
info [sanity] Stitching GraphQL schemas from SDL
```
- Sanity's `allPizza` turns into Gatsby's `allSanityPizza`

```js
query MyQuery {
  sanityPizza (id:{eq:"-b92d2870-50ea-57e3-a2ce-9da813a9e2dc"}) {
    name
    toppings{
      name
    }
  }
}
```
- Good to stumble over the `StringQueryOperatorInput` type expected as a parameter to the `sanityPizza` query
  - `{eq:"..."}` 

### Gatsby Queries

- Page level queries vs static queries
- If you want _variables_ in your query, you need to use a page-level query

```js
import { graphql } from 'gatsby';

export default function PizzasPage({ data }) { ... }

export const query = graphql`
  query PizzaQuery {
    pizzas: allSanityPizza {
```
- "Gatsby magic" that the exported `graphql` template literal is injected into the page components props at `data`

```js
image {
  asset {
    fluid(maxWidth: 400) {
      ...GatsbySanityImageFluid
    }
  }
}
```
- `GatsbySanityImageFluid` is a __fragment__ provided by Sanity

```js
fragment comparisonFields on Character {
  name
  appearsIn
  friends {
    name
  }
}
```
- Fragments seem great: https://graphql.org/learn/queries/#fragments
>  Fragments let you construct sets of fields, and then include them in queries where you need to. 
- Select a component using _React Dev Tools_ and in the console can log it out using `$r`
  - e.g. `$r.props.pizza.toppings.map(t => t.name).join(',')`

## Modules 6: Puttin' in Work

### Gatsby Images

- https://www.gatsbyjs.com/plugins/gatsby-image/

` resolve: `gatsby-source-filesystem`,`
  - Sourcing images from a local directory can lead to long build times

- Alternative is to use an on demand service
  - Sanity Image Pipeline
  - Cloudinary
  - Imgix
- Our processed image properties are exposed via the `GatsbySanityImageFluid` fragment in our `pizzas` GraphQL query

```js
import Img from 'gatsby-image';
...
<Img fluid={pizza.image.asset.fluid} alt={pizza.name} />
```

### Loading in Sample Data

`sanity dataset import ./sample-data/all-sample-data.gz production`

### Styling the Grid with CSS SubGrid

```css
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 4rem;
grid-auto-rows: auto auto 500px;
```
- Good to see `repeat` function modelled
  - Feels a bit questionable to hard code the `300px`, which is related to the max-width on the page 


```css
/* Take your row sizing not from the pizzaStyles div, but from the  PizzaGridStyles grid */
@supports not (grid-template-rows: subgrid) {
  --rows: auto auto 1fr;
}
grid-template-rows: var(--rows, subgrid);
grid-row: span 3;
```
- `subgrid` is a bit new (no Chrome at present), but good exposure to the concept
  - Basically saying the 3 children below should inherit the rows settings from their parent
- Nice use of `@supports not` and a fallback value in `var()`
  - If `--rows` doesn't exist, just use subgrid
  - Good browser compatibility trick

```js
<PizzaStyles>
  <Link to={`/pizza/${pizza.slug.current}`}>
    <h2>
      <span className="mark">{pizza.name}</span>
    </h2>
  </Link>
  <p>{pizza.toppings.map((topping) => topping.name).join(', ')}</p>
  <Img fluid={pizza.image.asset.fluid} alt={pizza.name} />
</PizzaStyles>
```